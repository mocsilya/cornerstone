{{assignVar "hasVariants" "false"}}
{{#if gql.data.site.product}}
	{{#each gql.data.site.product.variants.edges}}
		{{#with node}}
			{{#if @last}}
				{{#unless @index 0}}
					{{assignVar "hasVariants" "true"}}
				{{/unless}}
			{{/if}}
		{{/with}}
	{{/each}}
{{/if}}

<script>
	let inputElem = document.querySelector('.form-input--incrementTotal');
	let buttonElem = document.querySelectorAll('.form-increment .button');
{{#if (getVar "hasVariants") '===' 'false'}}
	// without Variants
	{{#if product.stock_level ">" 0}}
		let allStock = {{product.stock_level}};
	{{else}}
		let allStock = 0;
	{{/if}}
	
	{{#if gql.data.site.product.inventory.aggregated.warningLevel ">" 0}}
		let supplierStock = {{gql.data.site.product.inventory.aggregated.warningLevel}};
	{{else}}
		let supplierStock = 0;
	{{/if}}

	let inStock = allStock - supplierStock;
	if (inStock < 1) {
		inStock = 0;
	}
	if (supplierStock > allStock) {
		supplierStock = allStock;
	}
	console.log('allStock: ' + allStock);
	console.log('supplierStock: ' + supplierStock);
	console.log('inStock: ' + inStock);
	document.addEventListener("DOMContentLoaded", function(event) { 
		if (inStock > 0) {
			document.querySelector('.availability-now').style.display = 'block';
		} else {
			if (allStock > 0) {
				document.querySelector('.availability-soon').style.display = 'block';
			} else {
				document.querySelector('.availability-none').style.display = 'block';
			}
		}	
	});
{{else}}
	// with Variants 
	var variants = {
	{{#each gql.data.site.product.variants.edges}}
		{{#with node}}
			{{#if @last}}
				'{{sku}}_allStock': '{{inventory.aggregated.availableToSell}}',
				'{{sku}}_supplierStock': '{{inventory.aggregated.warningLevel}}'
			{{else}}
				'{{sku}}_allStock': '{{inventory.aggregated.availableToSell}}',
				'{{sku}}_supplierStock': '{{inventory.aggregated.warningLevel}}',
			{{/if}}
		{{/with}}
	{{/each}}
	};
	let allStock;
	let supplierStock;
	let inStock;
	var timeStart = 0;
	var optionClick = document.querySelectorAll(".productView-options .form-radio, .productView-options .form-select");
	for (let i = 0; i < optionClick.length; i++) {
		optionClick[i].addEventListener("change", function() {
			clearTimeout(timeStart);
		    timeStart = setTimeout(function() {

				const elemSku = document.querySelector(".productView-info-value.sku-value");
		        const varSku = elemSku.innerText;
				const varAll = varSku + '_allStock';
				const varSupplier = varSku + '_supplierStock';
		
				allStock = Number(variants[varAll]);
				supplierStock = Number(variants[varSupplier]);
				inStock = allStock - supplierStock;
				if (inStock < 1) {
					inStock = 0;
				}
				if (supplierStock > allStock) {
					supplierStock = allStock;
				}
				const userQty = inputElem.value;
				
				console.log('varSku: ' + varSku);
				console.log('allStock: ' + allStock);
				console.log('supplierStock: ' + supplierStock);
				console.log('inStock: ' + inStock);
				console.log('userQty: ' + userQty);
				
				if (userQty <= inStock) {
					document.querySelector('.availability-now').style.display = 'block';
					document.querySelector('.availability-soon').style.display = 'none';
					document.querySelector('.availability-none').style.display = 'none';
				} else {
					if (userQty <= allStock) {
						document.querySelector('.availability-soon').style.display = 'block';
						document.querySelector('.availability-now').style.display = 'none';
						document.querySelector('.availability-none').style.display = 'none';
					} else {
						document.querySelector('.availability-none').style.display = 'block';
						document.querySelector('.availability-soon').style.display = 'none';
						document.querySelector('.availability-now').style.display = 'none';
					}
				}
        
		    }, 1000);
		});
	}
{{/if}}

	if (inputElem) {
		// monitor the quantity input directly
	    inputElem.addEventListener('input', () => {
			const userQty = inputElem.value;
			if (allStock == null){
				document.querySelector('.availability-now').style.display = 'none';
				document.querySelector('.availability-soon').style.display = 'none';
				document.querySelector('.availability-none').style.display = 'none';
			} else {
				if (userQty <= inStock) {
					document.querySelector('.availability-now').style.display = 'block';
					document.querySelector('.availability-soon').style.display = 'none';
					document.querySelector('.availability-none').style.display = 'none';
				} else {
					if (userQty <= allStock) {
						document.querySelector('.availability-soon').style.display = 'block';
						document.querySelector('.availability-now').style.display = 'none';
						document.querySelector('.availability-none').style.display = 'none';
					} else {
						document.querySelector('.availability-none').style.display = 'block';
						document.querySelector('.availability-soon').style.display = 'none';
						document.querySelector('.availability-now').style.display = 'none';
					}
				}
			}
	    });
		// monitor the quantity + / - buttons
		for (let i = 0; i < buttonElem.length; i++) {
		    buttonElem[i].onclick = function () {
		        buttonTimer = setTimeout(() => {
					const userQty = inputElem.value;
					console.log('inStockLive: ' + inStock);
					console.log('allStockLive: ' + allStock);
					console.log('userQty: ' + userQty);
					if (allStock == null){
						document.querySelector('.availability-now').style.display = 'none';
						document.querySelector('.availability-soon').style.display = 'none';
						document.querySelector('.availability-none').style.display = 'none';
					} else {
						if (userQty <= inStock) {
							document.querySelector('.availability-now').style.display = 'block';
							document.querySelector('.availability-soon').style.display = 'none';
							document.querySelector('.availability-none').style.display = 'none';
						} else {
							if (userQty <= allStock) {
								document.querySelector('.availability-soon').style.display = 'block';
								document.querySelector('.availability-now').style.display = 'none';
								document.querySelector('.availability-none').style.display = 'none';
							} else {
								document.querySelector('.availability-none').style.display = 'block';
								document.querySelector('.availability-soon').style.display = 'none';
								document.querySelector('.availability-now').style.display = 'none';
							}
						}
					}
		            clearTimeout(buttonTimer);
		        }, 500);
		    }
		}
	}
</script>

<script>
	let textLabel = document.querySelectorAll('.productView-options .form-label small');
	for (let i = 0; i < textLabel.length; i++) {
		const labelContent = textLabel[i].innerText;
		const labelString = '{{lang "common.required"}}';
		if (labelContent.includes(labelString)) {
			textLabel[i].innerText = 'Select Option Below';
		}
	}
</script>


<!-- Old script for 1000 system 

{{assignVar "nobackorder" "false"}}
{{#filter product.custom_fields 'hidden' property='name'}}
	{{#if value '==' 'nobackorder'}}
		{{assignVar "nobackorder" "true"}}
	{{/if}}
{{/filter}}

{{assignVar "hasVariants" "false"}}
{{assignVar "aboveZero" "false"}}
{{assignVar "above1000" "false"}}
{{#if gql.data.site.product}}
	{{#each gql.data.site.product.variants.edges}}
		{{#with node}}
			{{#if @last}}
				{{#unless @index 0}}
					{{assignVar "hasVariants" "true"}}
				{{/unless}}
			{{/if}}
	        {{#if isPurchasable}}
				{{#if inventory.aggregated.availableToSell ">" 1000}}
					{{assignVar "above1000" "true"}}
				{{/if}}
				{{#if inventory.aggregated.availableToSell ">" 0}}
					{{assignVar "aboveZero" "true"}}
				{{/if}}
			{{/if}}
		{{/with}}
	{{/each}}
{{/if}}

{{#if (getVar "nobackorder") '===' 'false'}}
<script>
	{{#if (getVar "hasVariants") '===' 'true'}}
		{{#if (getVar "above1000") '===' 'true'}}
			let inStock = 1001;
		{{else}}
			{{#if (getVar "aboveZero") '===' 'true'}}
				let inStock = 999;
			{{else}}
				let inStock = 0;
			{{/if}}
		{{/if}}
	{{else}}
		let inStock = {{#if product.stock_level}}{{#if product.can_purchase}}{{product.stock_level}}{{else}}0{{/if}}{{else}}0{{/if}};
		// let inStock = {{#if product.stock_level}}{{#if product.can_purchase}}{{#gt product.stock_level 1000}}{{subtract product.stock_level 1000}}{{else}}0{{/gt}}{{else}}0{{/if}}{{else}}0{{/if}};
	{{/if}}
	{{#if (getVar "hasVariants") '===' 'false'}}
	document.addEventListener("DOMContentLoaded", function(event) { 
		if (inStock > 1000) {
			document.querySelector('.availability-now').style.display = 'block';
		} else {
			if (inStock > 0) {
				document.querySelector('.availability-soon').style.display = 'block';
			}
		}	
	});
	{{/if}}
	let inputElem = document.querySelector('.form-input--incrementTotal');
	let buttonElem = document.querySelectorAll('.form-increment .button');
	let messageDiv = document.getElementById('backorderMessage');
	var timeStart = 0;
	var optionClick = document.querySelectorAll(".productView-options .form-radio, .productView-options .form-select");
	for (let i = 0; i < optionClick.length; i++) {
		optionClick[i].addEventListener("change", function() {
			clearTimeout(timeStart);
		    timeStart = setTimeout(function() {

				const stockData = document.querySelector(".in-stock-number");
		        if (stockData === null) {
		            inStock = 0;
		        } else {
		            inStock = Number(stockData.innerText);
		        }
				console.log('instock: ' + inStock);
		        // set the message
				const availabilityNow = document.querySelector('.availability-now');
				const availabilitySoon = document.querySelector('.availability-soon');
				if (inStock == 0) {
					const outofStock = document.querySelector('.add-to-cart-wrapper .alertBox').offsetHeight;
					if (outofStock > 0) {
					    availabilityNow.style.display = 'none';
						availabilitySoon.style.display = 'none';
					}
				} else {
					if (inStock > 1000) {
					    availabilityNow.style.display = 'block';
						availabilitySoon.style.display = 'none';
					} else {
						availabilityNow.style.display = 'none';
						availabilitySoon.style.display = 'block';
					}
				}
			
				messageDiv.style.display = 'none';
		    }, 1500);
		});
	}

	if (inputElem) {
		// monitor the quantity input directly
	    inputElem.addEventListener('input', () => {
			if (inStock > 999) {
				const availableQty = inStock - 1000;
				const userQty = inputElem.value;
				if (userQty > availableQty) {
					const backOrder = userQty - availableQty;
		            messageDiv.innerHTML = '<span>' + availableQty + '</span> in stock (Order by 1pm for Next Working Day Delivery or collect immediately in-store). <span>' + backOrder + '</span> on back order ({{#if product.availability}}{{#contains product.availability "//"}}{{after (split product.availability "//") 1}}{{else}}{{product.availability}}{{/contains}}{{else}}{{after (split theme_settings.custom_product_availability "//") 1}}{{/if}})';
		            messageDiv.style.display = 'block';
		        } else {
		            messageDiv.style.display = 'none';
		        }
			}
	    });
		// monitor the quantity + / - buttons
		for (let i = 0; i < buttonElem.length; i++) {
		    buttonElem[i].onclick = function () {
		        buttonTimer = setTimeout(() => {
					if (inStock > 999) {
						const availableQty = inStock - 1000;
						const userQty = inputElem.value;
			            if (userQty > availableQty) {
							const backOrder = userQty - availableQty;
			                messageDiv.innerHTML = '<span class="num-available">' + availableQty + '</span> in stock (Order by 1pm for Next Working Day Delivery or collect immediately in-store). <span class="num-backorder">' + backOrder + '</span> on back order ({{#if product.availability}}{{#contains product.availability "//"}}{{after (split product.availability "//") 1}}{{else}}{{product.availability}}{{/contains}}{{else}}{{after (split theme_settings.custom_product_availability "//") 1}}{{/if}})';
			                messageDiv.style.display = 'block';
			            } else {
			                messageDiv.style.display = 'none';
			            }
					}
		            clearTimeout(buttonTimer);
		        }, 500);
		    }
		}
	}
</script>
{{else}}
	{{#if product.can_purchase}}
		<script>
		const availabilityNow = document.querySelector('.availability-now');
		availabilityNow.style.display = 'block';
		</script>
	{{/if}}
{{/if}}
-->

